-- things to do
-- fix ball shoot
-- new move function
-- manage server movement
-- fix turret rotating


-- Local Script For Managing Game

-- Services
local LocalPlayer = game:GetService("Players").LocalPlayer
local UserInput = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RStorage = game:GetService("ReplicatedStorage").remoteEvents

-- Pointer Events
local SendEvent = RStorage:WaitForChild("remoteEventSendToServer")
local AskEvent = RStorage:WaitForChild("AskServerFunction")
local ReciveEvent = RStorage:WaitForChild("remoteEventSendToClient")
local newRotationEvent = RStorage:WaitForChild("newRotationToClient")
local newMoveEvent = RStorage:WaitForChild("newMoveToClient")
local newObjectEvent = RStorage:WaitForChild("newObjectToClient")
local newRemoveEvent = RStorage:WaitForChild("newRemoveToClient")

-- Pointers
local Controls = require(LocalPlayer.PlayerScripts.PlayerModule):GetControls()
local Mouse = LocalPlayer:GetMouse()

-- Gui Pointers
local gui = LocalPlayer.PlayerGui
local guiGameFrame = gui.ScreenGui.Frame
local ThisUserGui = guiGameFrame:WaitForChild("playerFrame")
local turret = ThisUserGui.Turret

local RefObjects = gui:WaitForChild("refrenceObjects")

local guiObjectHealth = gui.ScreenGui.bottomInfoDisplay.playerHeathGui.background.health
local guiObjectHealthMaxSize = guiObjectHealth.AbsoluteSize.X
local guiObjectCurrentHealth = 0
local guiObjectCurrentHealthMax = 0
local guiObjectHealthOld = 0

local roamObjects = guiGameFrame.gameFrame.roamingObjects
local roamPlayers = guiGameFrame.gameFrame.roamingPlayers
local guiFrame = gui.StartGui.Frame
local playButton = guiFrame.playButton.Button
local displayNameButton = guiFrame.playerName.Frame.Button

-- Player Refernce Data For Later
local playerPositionX = 0
local playerPositionY = 0
local playerPosition = Vector2.new(playerPositionX, playerPositionY)

local playerSpeed = 0
local playerMoveingTo = {W = false, S = false, A = false, D = false}
local playerMouseHold = false
local inGame = false
local moveByServerQuest = {W = false, S = false, A = false, D = false}

-- Max Game Boundries
local minY = 0
local maxY = 1
local minX = 0
local maxX = 1

local gamePlayers = {


}

local movingData = {


}

local lockedData = {


} 

local mobs = {


}

local defaultPlayerInfo = {}

-- Stop Physical Player Movement
Controls:Disable()

-- Move A 2d Gui Object
local function moveObject(object: ObjectValue, goal: UDim2, timeLength: NumberValue, stopOldTween: boolean)
	
	object:TweenPosition(
		goal,
		Enum.EasingDirection.In,
		Enum.EasingStyle.Linear,
		timeLength,
		stopOldTween
	)
end

-- Move A Players Turret
local function moveTurret(object: ObjectValue, goal: IntValue, rotationStart: IntValue)
	
	if goal > rotationStart then
		for count = rotationStart, goal, 2 do task.wait(0.03)
			object.Rotation = object.Rotation + 2
		end
	else
		for count = rotationStart, goal, -2 do task.wait(0.03)
			object.Rotation = object.Rotation - 2
		end
	end

end

local function removeObject(id: StringValue, oType: StringValue)
	if oType == "ball" then

		local find = roamObjects:FindFirstChild(id)
		if find then
			
			find:TweenSize(
				UDim2.new(0, 0, 0, 0),
				Enum.EasingDirection.In,
				Enum.EasingStyle.Linear,
				0.3
			)
			task.wait(0.3)
			find:Destroy()
		end
	end

	if oType == "player" then
		
		local find = roamPlayers:FindFirstChild(id)
		if find then
			find.player.BackgroundColor3 = Color3.fromRGB(122, 36, 36)
			find.player.player.BackgroundColor3 = Color3.fromRGB(255, 41, 41)
			find.Turret.Turret.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
			find:TweenSize(
				UDim2.new(0, 0, 0, 0),
				Enum.EasingDirection.In,
				Enum.EasingStyle.Linear,
				0.3
			)
			task.wait(0.3)
			find:Destroy()
		end
	end

end

-- Create A New 2d Object
local function createNewObject(oType: StringValue, location: Vector2, movingTo: Vector2, speed: NumberValue, rotation: IntValue, name: StringValue, id: StringValue)

	-- Create Ball Object
	if oType == "ball" then
		local ball = RefObjects.ball:Clone()
		ball.Name = ("B"..math.random(0, 9999))
		ball.Position = UDim2.new(0, location.X, 0, location.Y)
		ball.Parent = roamObjects
		ball.Rotation = turret.Rotation

		if speed > 0 then
			moveObject(ball, UDim2.new(0, location.X + ball.Rotation, 0, location.Y + ball.Rotation), 2, true)
		end
		task.wait(2)
		removeObject(ball.Name, "ball")
	end
	-- Create A New User
	if oType == "player" then
		local person = RefObjects.playerFrame:Clone()
		person.Name = id
		person.player.textName.Text = name
		person.Position = UDim2.new(0, location.X, 0, location.Y)
		person.Parent = roamPlayers
		person.Turret.Rotation = rotation

		if speed > 0 then
			moveObject(person, UDim2.new(0, movingTo.X, 0, movingTo.Y), speed * 2, true)
		end
	end

end

-- User Left Clicks
Mouse.Button1Down:Connect(function()
	if inGame == true then
		playerMouseHold = true
	
		while playerMouseHold == true do
			createNewObject("ball", playerPosition + (turret.Turret.ballSpawn.AbsolutePosition - (guiGameFrame.AbsoluteSize/2)), nil, 20)
			task.wait(0.5)
		end
 	end
end)

-- End Click
Mouse.Button1Up:Connect(function()
	
	playerMouseHold = false
	
end)

-- Update Information To Server
local function updateToSever()
	
	SendEvent:FireServer("update", playerMoveingTo, turret.Rotation)
	
end

-- Update Information From Server
local displayBoolen: BoolValue, nameText: StringValue, displayNameText: StringValue, maxGameBounds: NumberValue = AskEvent:InvokeServer("getPlayerInformation")

guiGameFrame.gameFrame.Size = UDim2.new(0, maxGameBounds, 0 , maxGameBounds)

-- Load Background
local thickness = 4
local color = Color3.fromRGB(19, 175, 58)
local maxsizeX = guiGameFrame.gameFrame.AbsoluteSize.X
local maxsizeY = guiGameFrame.gameFrame.AbsoluteSize.Y
local count = 0
repeat
	count += 35
	local line = Instance.new("Frame")
	line.Parent = guiGameFrame.gameFrame.lineFrame
	line.BackgroundColor3 = color
	line.Size = UDim2.new(0, thickness, 1, 0)
	line.Position = UDim2.new(0, count, 0, 0)
	line.BorderSizePixel = 0
	count += thickness
until count >= maxsizeX
count = 0
repeat
	count += 35
	local line = Instance.new("Frame")
	line.Parent = guiGameFrame.gameFrame.lineFrame
	line.BackgroundColor3 = color
	line.Size = UDim2.new(1, 0, 0, thickness)
	line.Position = UDim2.new(0, 0, 0, count)
	line.BorderSizePixel = 0
	count += thickness
until count >= maxsizeY

if displayBoolen == true then
	displayNameButton.Text = ("X")
else
	displayNameButton.Text = ("")
end

if displayNameText ~= "{nil}" then
	displayNameButton.Parent.TextLabel.Text = (displayNameText)
else
	guiFrame.playerName.Frame.Visible = false
end

-- Max Allowed player Bounds
local function getNewMaxBounds()
	minY = 0 + ThisUserGui.player.player.AbsoluteSize.Y/2
	maxY = guiGameFrame.gameFrame.AbsoluteSize.Y - ThisUserGui.player.player.AbsoluteSize.Y/2

	minX = 0 + ThisUserGui.player.player.AbsoluteSize.X/2
	maxX = guiGameFrame.gameFrame.AbsoluteSize.X - ThisUserGui.player.player.AbsoluteSize.X/2
	
end

getNewMaxBounds()

-- New Move Function
local function movePos(letter: StringValue, negative: boolean, V)
	local s = playerSpeed
	playerMoveingTo[letter] = true
	updateToSever()

	while UserInput:IsKeyDown(Enum.KeyCode[letter]) do task.wait(0.03)
		
		if negative == true then s = -playerSpeed else s = playerSpeed end

		playerPositionY = math.clamp(playerPosition[V] + s, minY, maxY)

		playerPosition = Vector2.new(playerPositionX, playerPositionY)
		guiGameFrame.gameFrame.Position = UDim2.new(0, -playerPosition.X + guiGameFrame.AbsoluteSize.X/2, 0, -playerPosition.Y)
	end

	playerMoveingTo[letter] = false
	updateToSever()

end

-- Position Counter
local function onChanged()

	gui.ScreenGui.positionCounter.TextLabel.Text = (playerPosition.X..","..playerPosition.Y)

end
onChanged()

-- User Uses Keyboard
UserInput.InputBegan:Connect(function(key: InputObject, gameProcessed:boolean)
	if gameProcessed or inGame == false then return end

	if (key.KeyCode == Enum.KeyCode.W) then
		playerMoveingTo.W = true
		updateToSever()
		while UserInput:IsKeyDown(Enum.KeyCode.W) do task.wait(0.03) onChanged()
			--if moveByServerQuest.W == false then
				playerPositionY = math.clamp(playerPosition.Y -playerSpeed, minY, maxY)
				playerPosition = Vector2.new(playerPositionX, playerPositionY)
				guiGameFrame.gameFrame.Position = UDim2.new(0, -playerPosition.X + guiGameFrame.AbsoluteSize.X/2, 0, -playerPosition.Y + guiGameFrame.AbsoluteSize.Y/2)
			--	end
			end
		playerMoveingTo.W = false
		updateToSever()
	end
	
	if (key.KeyCode == Enum.KeyCode.S) then
		playerMoveingTo.S = true
		updateToSever()
		while UserInput:IsKeyDown(Enum.KeyCode.S) do task.wait(0.03) onChanged()
			--if moveByServerQuest.S == false then
				playerPositionY = math.clamp(playerPosition.Y +playerSpeed, minY, maxY)
				playerPosition = Vector2.new(playerPositionX, playerPositionY)
				guiGameFrame.gameFrame.Position = UDim2.new(0, -playerPosition.X + guiGameFrame.AbsoluteSize.X/2, 0, -playerPosition.Y + guiGameFrame.AbsoluteSize.Y/2)
			--	end
			end
		playerMoveingTo.S = false
		updateToSever()
	end
	
	if (key.KeyCode == Enum.KeyCode.A) then
		playerMoveingTo.A = true
		updateToSever()
		while UserInput:IsKeyDown(Enum.KeyCode.A) do task.wait(0.03) onChanged()
			--if moveByServerQuest.A == false then
				playerPositionX = math.clamp(playerPosition.X -playerSpeed, minX, maxX)
				playerPosition = Vector2.new(playerPositionX, playerPositionY)
				guiGameFrame.gameFrame.Position = UDim2.new(0, -playerPosition.X + guiGameFrame.AbsoluteSize.X/2, 0, -playerPosition.Y + guiGameFrame.AbsoluteSize.Y/2)
			--	end
			end
		playerMoveingTo.A = false
		updateToSever()
	end

	if (key.KeyCode == Enum.KeyCode.D) then
		playerMoveingTo.D = true
		updateToSever()
		while UserInput:IsKeyDown(Enum.KeyCode.D) do task.wait(0.03) onChanged()
			--if moveByServerQuest.D == false then
				playerPositionX = math.clamp(playerPosition.X +playerSpeed, minX, maxX)
				playerPosition = Vector2.new(playerPositionX, playerPositionY)
				guiGameFrame.gameFrame.Position = UDim2.new(0, -playerPosition.X + guiGameFrame.AbsoluteSize.X/2, 0, -playerPosition.Y + guiGameFrame.AbsoluteSize.Y/2)
			--end
		end
		playerMoveingTo.D = false
		updateToSever()
	end
	
	
end)

-- Request To Rotate An Object
local function onGetRequestRotation(id: StringValue, dataType: StringValue, rotation: IntValue)

	if dataType == "player" then
		
			moveTurret(roamPlayers[id].Turret, rotation, roamPlayers[id].Turret.Rotation)
	
	end

end
newRotationEvent.OnClientEvent:Connect(onGetRequestRotation)

-- Request To Move An Object
local function onGetRequestMove(id: StringValue, dataType: StringValue, posTo: Vector2, moveW: boolean, moveS: boolean, moveA: boolean, moveD: boolean)

	if dataType == "player" then
		local find = false
		
		for i, o in pairs(gamePlayers) do
		if o.id == id then find = true end
		end
		if find then
			
			moveObject(roamPlayers[id], UDim2.new(0, posTo.X, 0, posTo.Y), 0.5, false)

		end
	end
	
	if id == LocalPlayer.UserId then
		
		playerPositionY = posTo.Y
		playerPositionX = posTo.X
		playerPosition = posTo
		
		moveByServerQuest = {W = moveW, S = moveS, A = moveA, D = moveD}

		guiGameFrame.gameFrame:TweenPosition(
			UDim2.new(0, -playerPosition.X + guiGameFrame.AbsoluteSize.X/2, 0, -playerPosition.Y+ guiGameFrame.AbsoluteSize.Y/2),
			Enum.EasingDirection.In,
			Enum.EasingStyle.Linear,
			0.4,
			false
		)
	end
	
end
newMoveEvent.OnClientEvent:Connect(onGetRequestMove)

-- Request To Create An Object
local function onGetRequestCreate(id: StringValue, dataType: StringValue, object: Player_Array)

	if dataType == "player" then
		local find = false

		for i, o in pairs(gamePlayers) do
			if o.id == id then find = true end
		end
		
		if not find and id ~= LocalPlayer.UserId then
		
			createNewObject("player", object[1], object[1], 0, object[12], object[4], object[5])

			gamePlayers[id] = {defaultPlayerInfo}
			local user = gamePlayers[id]
			--position, quad, radius, displayName, id, speed, tank, health, maxHealth, bodyDamage, bodyBounce, rotation, movingTo, lastCPUupdate
			user["position"] = object[1]
			user["quad"] = object[2]
			user["radius"] = object[3]
			user["displayName"] = object[4]
			user["id"] = object[5]
			user["speed"] = object[6]
			user["tank"] = object[7]
			user["health"] = object[8]
			user["maxHealth"] = object[9]
			user["bodyDamage"] = object[10]
			user["bodyBounce"] = object[11]
			user["rotation"] = object[12]
			user["movingTo"] = object[13]
			user["lastCPUupdate"] = object[14]
		end
	end

end
newObjectEvent.OnClientEvent:Connect(onGetRequestCreate)

-- Request To Destroy An Object
local function onGetRequestRemove(id: StringValue, dataType: StringValue)

	if dataType == "player" then
		local find = false

		for i, o in pairs(gamePlayers) do
			if o.id == id then find = true end
		end
		if find then
			removeObject(id, "player")

		end
	end

end
newRemoveEvent.OnClientEvent:Connect(onGetRequestRemove)


-- BLOCK HEALTH GUI
local function updateHealth(health: NumberValue, max: NumberValue)

	if health < 0 then 
		health = 0
	end

	-- Update Gui
	guiObjectHealth.Size = UDim2.new(0, guiObjectHealthOld/max * guiObjectHealthMaxSize, 1, 0)

	-- TWEEN HEALTH
	local Tween = guiObjectHealth:TweenSize(
		UDim2.new(0, (health/max * guiObjectHealthMaxSize), 1, 0),
		Enum.EasingDirection.Out,
		Enum.EasingStyle.Quad,
		0.7,
		true 
	)

	-- End
	guiObjectHealth.Parent.Parent.number.Text = (health.."/"..max)
	
	guiObjectHealthOld = health

end

-- Start Game
local function onPlayButtonActivated()
	gui.StartGui.Enabled = false
	guiGameFrame.playerFrame.Visible = true
	gui.ScreenGui.positionCounter.Visible = true
	gui.ScreenGui.bottomInfoDisplay.Visible = true
	
	
	local canJoin: BoolValue, joinpos: Vector2, health: IntValue, maxhealth: IntValue, display: StringValue, speed: IntValue, tank: StringValue = AskEvent:InvokeServer("addPlayerInformation")
	
	if canJoin == true then
		
		playerSpeed = speed
		
		playerPositionX = joinpos.X
		playerPositionY = joinpos.Y
		playerPosition = Vector2.new(playerPositionX, playerPositionY)
		guiGameFrame.gameFrame.Position = UDim2.new(0, -playerPosition.X + guiGameFrame.AbsoluteSize.X/2, 0, -playerPosition.Y+ guiGameFrame.AbsoluteSize.Y/2)
		
		updateHealth(health, maxhealth)
		
		-- Update current user turret rotation function
		local rotateTurretFunction = Mouse.Move:Connect(function()

			local frameCenter = turret.AbsolutePosition
			local x = math.atan2(Mouse.Y - frameCenter.Y, Mouse.X - frameCenter.X)
			turret.Rotation = math.deg(x)
		end)

		
		inGame = true

	else
		warn("Denied game entry")
	end
	
end
playButton.Activated:Connect(onPlayButtonActivated)

local function onDisplayName()

	displayBoolen = not displayBoolen

	if displayBoolen == true then
		displayNameButton.Text = ("X")
	else
		displayNameButton.Text = ("")
	end
end
displayNameButton.Activated:Connect(onDisplayName)

local dayTable = {}

local dayTable = AskEvent:InvokeServer("getDayInformation")

local function updateDaySlider(object: ObjectValue, info: IntValue, weekDay: StringValue)
	local changed = false
	object.inside.label.Text = weekDay
	if (info > -1 and info < 75) or (info > 345 and info < 366) then
		object.inside.BackgroundColor3 = Color3.fromRGB(146, 174, 180)
		
		if info == 358 or info == 359 or info == 360 then
			changed = true
			object.inside.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
		end
		
	end
	
	if info > 75 and info < 165 then
		object.inside.BackgroundColor3 = Color3.fromRGB(96, 234, 32)

	end
	
	if info > 165 and info < 255 then
		object.inside.BackgroundColor3 = Color3.fromRGB(12, 165, 1)

	end
	
	if info > 255 and info < 345 then
		object.inside.BackgroundColor3 = Color3.fromRGB(208, 121, 0)
		
		if info == 303 or info == 304 or info == 305 then
			changed = true
			object.inside.BackgroundColor3 = Color3.fromRGB(255, 140, 0)
		end
		
		
	end
	
	if changed == false then
		if weekDay == "Sat" then
			object.inside.BackgroundColor3 = Color3.fromRGB(0, 185, 213)
			object.inside.label.Text = "Quick"
			object.inside.label.TextColor3 = Color3.fromRGB(255, 0, 209)
		end
	end
end

local ima = guiFrame.dayFrame:GetChildren()

for i = 1, #ima do
	
	updateDaySlider(ima[i], tonumber(dayTable["d"..(i-1)]), dayTable["w"..(i-1)])

	ima[i].MouseEnter:Connect(function()

		ima[i].inside:TweenSize(
			UDim2.new(1, 3, 1, 3),
			Enum.EasingDirection.In,
			Enum.EasingStyle.Linear,
			0.3,
			true
		)


	end)

	ima[i].MouseLeave:Connect(function()

		ima[i].inside:TweenSize(
			UDim2.new(1, -6, 1, -6),
			Enum.EasingDirection.In,
			Enum.EasingStyle.Linear,
			0.15,
			true
		)
	end)


end

-- Recive a request from the server
local function onGetRequest(request: StringValue, id: StringValue, info, info2)

	if request == "health" and id == LocalPlayer.UserId then

		updateHealth(info, info2)

	end

end
ReciveEvent.OnClientEvent:Connect(onGetRequest)
